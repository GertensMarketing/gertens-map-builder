<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gertens Map Editor</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="gertens-blueprint-favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body, html { height: 100%; margin: 0; display: flex; flex-direction: column; font-family: sans-serif; overflow: hidden; }
        
        #container { display: flex; flex: 1; min-height: 0; position: relative; }
        #sidebar { width: 350px; background: #f8fafc; border-right: 1px solid #cbd5e1; display: flex; flex-direction: column; }
        #map { flex: 1; z-index: 1; }
        
        .row-item { transition: all 0.2s; border-left: 4px solid transparent; }
        .row-item:hover { background: #fff; border-color: #cbd5e1; }
        .row-item.active { border-left-color: #3b82f6; background: #eff6ff; border-color: #3b82f6; }
        
        .leaflet-draw-toolbar a[title="Clear all layers"], 
        .leaflet-draw-actions a[title="Clear all layers"] { display: none !important; }

        #modalOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; items-align: center; }
        #modalContent { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

        #toast { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: #333; color: white; padding: 12px 24px; border-radius: 50px; 
            font-size: 14px; font-weight: bold; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;
        }
        #toast.show { opacity: 1; }
        #toast.error { background: #ef4444; }
        #toast.success { background: #22c55e; }
        #toast.warning { background: #f59e0b; color: #fff; }

        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .snap-active { background-color: rgba(34, 197, 94, 0.2) !important; border-color: rgba(34, 197, 94, 0.5) !important; color: #86efac !important; }

        /* Coordinate Inspector Style */
        .coord-inspector {
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            color: #333;
            border: 1px solid #ccc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* AUTOCOMPLETE STYLES */
        .autocomplete-list {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 0 0 4px 4px;
        }
        .autocomplete-item {
            padding: 8px 10px;
            cursor: pointer;
            background-color: #fff; 
            border-bottom: 1px solid #d4d4d4;
            font-size: 12px;
            color: #333;
        }
        .autocomplete-item:hover {
            background-color: #e9e9e9; 
        }
        .autocomplete-active {
            background-color: #3b82f6 !important; 
            color: #ffffff; 
        }
        
        /* TAG INPUT STYLES */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 4px;
            min-height: 38px;
            cursor: text;
        }
        .tag-container:focus-within {
            border-color: #3b82f6;
            ring: 1px solid #3b82f6;
        }
        .tag {
            background: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
            padding: 2px 8px;
            border-radius: 9999px; /* pill shape */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            user-select: none;
        }
        .tag-close {
            cursor: pointer;
            color: #6b7280;
            font-size: 10px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }
        .tag-close:hover {
            background-color: #ef4444;
            color: white;
        }
        .tag-input {
            flex: 1;
            min-width: 80px;
            border: none;
            outline: none;
            font-size: 0.75rem;
            padding: 4px;
            background: transparent;
            color: #374151;
        }
        .tag-input::placeholder {
            color: #9ca3af;
        }

        /* IMAGE EDIT CONTROLS */
        #imageEditControls {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none; /* Flex when active */
            flex-direction: column;
            gap: 10px;
            min-width: 250px;
        }
        input[type=range] {
            accent-color: #3b82f6;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="bg-[#bb141a] text-white p-3 flex justify-between items-center shadow-md z-10 relative">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-seedling text-white text-xl opacity-90"></i>
            <div>
                <h1 class="font-bold text-lg leading-tight">Gertens Map Editor</h1>
                <div class="text-xs text-white/80">Manage Rows & Products</div>
            </div>
        </div>
        <div class="flex gap-2 items-center">
            <div class="flex bg-black/20 rounded mr-1">
                <button id="btnUndo" onclick="undo()" class="px-3 py-1 hover:bg-black/20 rounded-l border-r border-white/20 transition text-white" title="Undo (Ctrl+Z)"><i class="fa-solid fa-rotate-left"></i></button>
                <button id="btnRedo" onclick="redo()" class="px-3 py-1 hover:bg-black/20 rounded-r transition text-white" title="Redo (Ctrl+Y)"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <button id="btnSnap" onclick="toggleSnap()" class="bg-black/20 hover:bg-black/30 text-white px-3 py-1 rounded text-sm transition font-bold border border-white/10 mr-1 flex items-center gap-2" title="Align boxes to a grid"><i class="fa-solid fa-magnet"></i> <span id="snapText">Snap: OFF</span></button>
            <div class="relative">
                <button onclick="toggleAdvancedMenu()" class="bg-black/20 hover:bg-black/30 text-white px-3 py-1 rounded text-sm transition font-bold border border-white/10">ADVANCED <i class="fa-solid fa-caret-down ml-1 text-xs"></i></button>
                <div id="advancedMenu" class="hidden absolute right-0 top-full mt-2 w-72 bg-white rounded shadow-xl border border-gray-200 z-50 overflow-hidden text-gray-800">
                    <button onclick="confirmLoadCloud(); toggleAdvancedMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-100 border-b border-gray-100 flex items-start gap-3 transition">
                        <div class="bg-blue-100 p-2 rounded text-blue-600 mt-1"><i class="fa-solid fa-cloud-arrow-down"></i></div>
                        <div>
                            <div class="font-bold text-sm text-gray-800">Reset data to match spreadsheet</div>
                            <div class="text-xs text-gray-500 mt-0.5 leading-snug">Warning: Replaces edits with cloud data.</div>
                        </div>
                    </button>
                    <!-- Update Background Image -->
                    <button onclick="startImageUpdate(); toggleAdvancedMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-100 border-b border-gray-100 flex items-start gap-3 transition">
                        <div class="bg-purple-100 p-2 rounded text-purple-600 mt-1"><i class="fa-solid fa-image"></i></div>
                        <div>
                            <div class="font-bold text-sm text-gray-800">Update Background Image</div>
                            <div class="text-xs text-gray-500 mt-0.5 leading-snug">Overlay a custom map or drone photo.</div>
                        </div>
                    </button>
                    <!-- View Code -->
                    <button onclick="viewLockedImageCode(); toggleAdvancedMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-100 border-b border-gray-100 flex items-start gap-3 transition">
                        <div class="bg-gray-100 p-2 rounded text-gray-600 mt-1"><i class="fa-solid fa-code"></i></div>
                        <div>
                            <div class="font-bold text-sm text-gray-800">View Locked Image Code</div>
                            <div class="text-xs text-gray-500 mt-0.5 leading-snug">Get code to paste into Google Sheet.</div>
                        </div>
                    </button>
                </div>
            </div>
             <button onclick="downloadCSV()" class="bg-white/10 hover:bg-white/20 text-white border border-white/20 px-3 py-1 rounded text-sm transition font-semibold flex items-center gap-2" title="Download Backup CSV"><i class="fa-solid fa-file-csv"></i> CSV</button>
        </div>
    </div>

    <!-- Image Edit Controls -->
    <div id="imageEditControls">
        <div class="flex flex-col gap-1">
            <div class="text-sm font-bold text-gray-800">Adjust Image Overlay</div>
            <div class="text-xs text-gray-500">Drag center to move. Use slider to resize.</div>
        </div>
        
        <div class="flex items-center gap-3">
            <label class="text-xs font-bold text-gray-600 w-12">Opacity:</label>
            <input type="range" id="imgOpacitySlider" min="0.1" max="1.0" step="0.1" value="0.5" 
                   oninput="updateTempOpacity(this.value)" class="flex-1 cursor-pointer">
        </div>

        <div class="flex items-center gap-3">
            <label class="text-xs font-bold text-gray-600 w-12">Size:</label>
            <input type="range" id="imgSizeSlider" min="0.1" max="20.0" step="0.1" value="1.0" 
                   oninput="updateTempSize(this.value)" class="flex-1 cursor-pointer">
        </div>

        <div class="flex gap-2 pt-2 border-t border-gray-100">
            <button onclick="lockImage()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-1.5 rounded text-sm font-bold shadow transition">
                <i class="fa-solid fa-lock mr-1"></i> LOCK IMAGE
            </button>
            <button onclick="cancelImageUpdate()" class="px-3 py-1.5 text-gray-500 hover:text-red-500 hover:bg-red-50 rounded text-sm font-bold transition">
                Cancel
            </button>
        </div>
    </div>

    <div id="container">
        <!-- Sidebar -->
        <div id="sidebar" class="flex flex-col h-full shadow-xl z-20">
            <div class="flex-1 overflow-y-auto p-2 bg-slate-50">
                <h2 class="font-bold text-gray-500 mb-2 px-2 text-xs uppercase tracking-wider mt-4">Active Rows (<span id="rowCount">0</span>)</h2>
                <div id="rowsList" class="space-y-2 pb-10">
                    <div class="text-gray-400 text-sm italic text-center mt-10"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><br>Loading live data...</div>
                </div>
            </div>
            <!-- Sync Actions -->
            <div class="p-4 pb-8 bg-white border-t border-gray-200 space-y-2">
                <h3 class="font-bold text-gray-800 mb-2 text-sm">Save Changes:</h3>
                <div id="unsavedChangesMsg" class="hidden bg-red-50 border border-red-100 text-red-600 p-2 rounded text-xs font-bold text-center mb-2 animate-pulse">
                    <i class="fa-solid fa-circle-exclamation mr-1"></i> Changes have not been synced yet.<br>Use button below to sync to website.
                </div>
                <button id="syncBtn" onclick="syncToGoogle()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded shadow-sm flex items-center justify-center gap-3 transition">
                    <i class="fa-brands fa-google-drive text-2xl"></i>
                    <div class="flex flex-col text-left">
                        <span class="font-bold text-sm">Sync to Map Spreadsheet</span>
                        <span class="text-[10px] font-normal opacity-90 leading-tight">Updates map on website instantly.</span>
                    </div>
                </button>
            </div>
        </div>
        <div id="map"></div>
        
        <!-- Input Modal -->
        <div id="inputModalOverlay" class="hidden fixed inset-0 bg-black/50 z-[10000] flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg shadow-xl w-96">
                <h3 id="inputModalTitle" class="font-bold text-lg mb-2">Enter Value</h3>
                <input type="text" id="inputModalField" class="w-full border p-2 rounded mb-4" placeholder="...">
                <div class="flex justify-end gap-2">
                    <button onclick="closeInputModal()" class="px-4 py-2 bg-gray-200 rounded text-sm font-bold">Cancel</button>
                    <button id="inputModalConfirm" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold">OK</button>
                </div>
            </div>
        </div>

        <div id="modalOverlay" class="flex items-center justify-center"><div id="modalContent"><h3 id="modalTitle" class="font-bold text-lg mb-2">Title</h3><p id="modalMessage" class="text-gray-600 text-sm mb-4">Message</p><div id="modalActions" class="flex justify-end gap-2"></div></div></div>
        <div id="toast"><i id="toastIcon" class="fa-solid fa-info-circle"></i><span id="toastMessage">Notification</span></div>
    </div>

    <textarea id="hiddenCopy" class="hidden"></textarea>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo6MENz0SiOu7rr77XEqxcEbmYxvYCLSbBwPOBQoCe9bfW8PQIlMwVMGePG5zgnqC7LXNF3x6MrT6L/pub?gid=0&single=true&output=csv"; 
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw-wLQcYoDPacJeLHBmkexXQX8hQFzgNwTRKBP_SgW0cb7hncZW2LlfcHjR3-wLzvAbQQ/exec";
        const MASTER_LIST_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo6MENz0SiOu7rr77XEqxcEbmYxvYCLSbBwPOBQoCe9bfW8PQIlMwVMGePG5zgnqC7LXNF3x6MrT6L/pub?gid=1166776934&single=true&output=csv"; 
        const MAP_IMAGE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo6MENz0SiOu7rr77XEqxcEbmYxvYCLSbBwPOBQoCe9bfW8PQIlMwVMGePG5zgnqC7LXNF3x6MrT6L/pub?gid=2021843794&single=true&output=csv";

        const DEFAULT_PLANTS = [
            "Hydrangea", "Hydrangea Paniculata", "Hydrangea Arborescens", "Hydrangea Macrophylla", "Hosta", "Hibiscus", "Helleborus",
            "Petunia", "Petunia Wave", "Pansy", "Peony", "Phlox", "Pepper", "Pumpkin",
            "Rose", "Rhododendron", "Rudbeckia", "Begonia", "Boxwood", "Basil",
            "Tomato", "Tulip", "Thuja", "Geranium", "Grass", "Gardenia",
            "Fern", "Fuchsia", "Forsythia"
        ];

        // --- CUSTOM IMAGE STATE ---
        let activeCustomImage = {
            url: "", 
            bounds: [[44.8710, -93.0530], [44.8735, -93.0500]], 
            opacity: 0.8,
            ratio: 1.0, 
            baseHeight: 0.001 
        };
        
        let tempImageLayer = null;     
        let tempControlBox = null;     
        let savedImageLayer = null;    

        const GRID_STEP = 0.00001;
        const ROW_TYPES = {
            "Annuals": "#8B0000", "Color Block": "#FF00FF", "Evergreens": "#006400", "Hardscapes": "#FFD700",
            "Mulch and Soils": "#800000", "Patio Furniture": "#8B4513", "Perennials": "#800080", "Pottery": "#40E0D0",
            "Roses & Vines": "#FFB6C1", "Shrubs": "#90EE90", "Trees": "#FFA500", "Tropicals": "#FF1493"
        };

        let map, drawnItems, rowsData = [], currentlyEditing = null, lastUsedType = "Annuals", snapEnabled = false, autoSaveInterval;
        let historyStack = [], historyIndex = -1;
        const MAX_HISTORY = 50; 
        let masterPlantList = [...DEFAULT_PLANTS]; 

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof L === 'undefined') { showToast("Error: Map library failed to load.", "error"); return; }

            map = L.map('map', { maxZoom: 20, minZoom: 17 }).setView([44.872063, -93.051572], 19);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri', maxZoom: 20 }).addTo(map);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20 }).addTo(map);
            
            // Initial Image Load (Fetch from Cloud)
            fetchMapImageConfig();
            
            // Coordinate Inspector
            const coordControl = L.control({ position: 'bottomleft' });
            coordControl.onAdd = function () {
                const div = L.DomUtil.create('div', 'coord-inspector');
                div.innerHTML = "Hover map for Lat/Lng";
                map.on('mousemove', function (e) {
                    div.innerHTML = `Lat: ${e.latlng.lat.toFixed(5)}<br>Lng: ${e.latlng.lng.toFixed(5)}`;
                });
                return div;
            };
            coordControl.addTo(map);

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                draw: { polyline: false, circle: false, marker: false, circlemarker: false, polygon: { allowIntersection: false, showArea: true }, rectangle: { shapeOptions: { color: ROW_TYPES["Annuals"], weight: 2 } } },
                edit: { featureGroup: drawnItems, remove: false }
            });
            map.addControl(drawControl);

            const saved = localStorage.getItem('gardenMapData');
            if (saved) { try { const parsed = JSON.parse(saved); loadDataToMap(parsed); recordHistory(parsed); } catch(e) { console.error("Save load error", e); } }
            else { recordHistory([]); }

            map.on(L.Draw.Event.CREATED, (e) => { 
                if(tempControlBox && e.layer === tempControlBox) return;
                handleCreate(e); markUnsaved(); 
            });
            map.on(L.Draw.Event.EDITED, (e) => { 
                let isControlBox = false;
                e.layers.eachLayer(l => {
                    if(l === tempControlBox) {
                        isControlBox = true;
                        updateImagePosition(); 
                    } else if(snapEnabled && l instanceof L.Rectangle) {
                        snapLayerToGrid(l);
                    }
                });
                if(!isControlBox) {
                    updateUI(); saveToLocal(); markUnsaved(); 
                }
            });
            map.on('click', () => disableAllEdits());
            document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); } if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) { e.preventDefault(); redo(); } });

            executeLoadCloud(true);
            fetchMasterPlantList();
            updateUndoRedoUI();
            autoSaveInterval = setInterval(() => saveToLocal(false, true), 30000);
        });

        // --- IMAGE OVERLAY LOGIC ---
        function fetchMapImageConfig() {
            if(!MAP_IMAGE_CSV_URL) return;
            Papa.parse(MAP_IMAGE_CSV_URL, {
                download: true, header: false,
                complete: function(results) {
                    let configStr = "";
                    for(let i=0; i<results.data.length; i++) {
                        for(let j=0; j<results.data[i].length; j++) {
                            const cell = results.data[i][j] || "";
                            if(cell.trim().startsWith("const CUSTOM_IMAGE")) {
                                const start = cell.indexOf('{');
                                const end = cell.lastIndexOf('}');
                                if(start > -1 && end > -1) {
                                    configStr = cell.substring(start, end+1);
                                    break;
                                }
                            } else if (cell.trim().startsWith("{") && cell.trim().includes("url")) {
                                configStr = cell.trim();
                                break;
                            }
                        }
                        if(configStr) break;
                    }

                    if(configStr) {
                        try {
                            const config = (new Function("return " + configStr))();
                            if(config.url && config.bounds) {
                                activeCustomImage = config;
                                if(savedImageLayer) map.removeLayer(savedImageLayer);
                                savedImageLayer = L.imageOverlay(config.url, config.bounds, { opacity: config.opacity || 0.8, zIndex: 2 }).addTo(map);
                                console.log("Loaded remote map image configuration.");
                            }
                        } catch(e) {
                            console.error("Failed to parse map image config from sheet", e);
                        }
                    }
                }
            });
        }

        function startImageUpdate() {
            const modal = document.getElementById('inputModalOverlay');
            const field = document.getElementById('inputModalField');
            const btn = document.getElementById('inputModalConfirm');
            
            document.getElementById('inputModalTitle').innerText = "Paste Image URL";
            field.value = "";
            field.placeholder = "https://example.com/map.jpg";
            modal.classList.remove('hidden');
            
            btn.onclick = () => {
                const url = field.value.trim();
                if(url) {
                    initImageEditor(url);
                    closeInputModal();
                }
            };
        }

        function closeInputModal() {
            document.getElementById('inputModalOverlay').classList.add('hidden');
        }

        function initImageEditor(url) {
            if(tempImageLayer) map.removeLayer(tempImageLayer);
            if(tempControlBox) map.removeLayer(tempControlBox);
            if(savedImageLayer) map.removeLayer(savedImageLayer);

            activeCustomImage.url = url;
            
            showToast("Loading image dimensions...", "info");

            const img = new Image();
            img.onload = function() {
                const aspectRatio = this.width / this.height;
                activeCustomImage.ratio = aspectRatio;
                
                const center = map.getCenter();
                activeCustomImage.baseHeight = 0.001; 
                
                const bounds = calculateBounds(center, 1.0); 

                const initialOpacity = 0.5;
                activeCustomImage.opacity = initialOpacity;

                tempImageLayer = L.imageOverlay(url, bounds, { opacity: initialOpacity }).addTo(map);
                tempControlBox = L.rectangle(bounds, { color: "#3b82f6", weight: 2, fill: false, dashArray: "5, 5" }).addTo(map);
                
                tempControlBox.editing.enable();
                
                tempControlBox.on('edit', updateImagePosition);
                tempControlBox.on('drag', updateImagePosition); 

                document.getElementById('imageEditControls').style.display = 'flex';
                document.getElementById('imgOpacitySlider').value = initialOpacity;
                document.getElementById('imgSizeSlider').value = 1.0;
                showToast("Image placed! Drag center to move, slider to resize.", "success");
            };
            
            img.onerror = function() {
                showToast("Error: Could not load image from URL.", "error");
            };
            
            img.src = url; 
        }

        function calculateBounds(centerLatLng, scale) {
            const h = activeCustomImage.baseHeight * scale;
            const centerLatRad = centerLatLng.lat * (Math.PI / 180);
            const w = h * activeCustomImage.ratio / Math.cos(centerLatRad);
            const halfH = h / 2;
            const halfW = w / 2;
            return [
                [centerLatLng.lat - halfH, centerLatLng.lng - halfW], 
                [centerLatLng.lat + halfH, centerLatLng.lng + halfW] 
            ];
        }

        function updateImagePosition() {
            if(tempControlBox && tempImageLayer) {
                tempImageLayer.setBounds(tempControlBox.getBounds());
            }
        }

        function updateTempOpacity(val) {
            if(tempImageLayer) {
                tempImageLayer.setOpacity(val);
                activeCustomImage.opacity = val;
            }
        }

        function updateTempSize(scale) {
            if(tempControlBox && tempImageLayer) {
                const currentBounds = tempControlBox.getBounds();
                const center = currentBounds.getCenter();
                const newBounds = calculateBounds(center, parseFloat(scale));
                tempControlBox.setBounds(newBounds);
                tempImageLayer.setBounds(newBounds);
            }
        }

        function lockImage() {
            if(tempControlBox && tempImageLayer) {
                const b = tempControlBox.getBounds();
                const bounds = [
                    [b.getSouthWest().lat, b.getSouthWest().lng],
                    [b.getNorthEast().lat, b.getNorthEast().lng]
                ];

                activeCustomImage.bounds = bounds;
                tempImageLayer.setOpacity(activeCustomImage.opacity);
                
                tempControlBox.editing.disable();
                map.removeLayer(tempControlBox);
                map.removeLayer(tempImageLayer);
                tempControlBox = null;
                tempImageLayer = null;

                savedImageLayer = L.imageOverlay(activeCustomImage.url, activeCustomImage.bounds, { opacity: activeCustomImage.opacity, zIndex: 2 }).addTo(map);

                document.getElementById('imageEditControls').style.display = 'none';
                viewLockedImageCode();
            }
        }

        function viewLockedImageCode() {
            if(!activeCustomImage.url) {
                showToast("No active image found.", "error");
                return;
            }
            const b = activeCustomImage.bounds;
            const codeString = `const CUSTOM_IMAGE = {\n    url: "${activeCustomImage.url}",\n    bounds: [\n        [${b[0][0].toFixed(6)}, ${b[0][1].toFixed(6)}],\n        [${b[1][0].toFixed(6)}, ${b[1][1].toFixed(6)}]\n    ],\n    opacity: ${activeCustomImage.opacity}\n};`;
            
            showModal("Map Image Configuration", "Paste this EXACTLY into Cell A2 of your 'Map Image' sheet tab.", [
                { text: "Close", class: "bg-blue-600 text-white", action: closeModal }
            ]);
            setTimeout(() => {
                document.getElementById('modalMessage').innerHTML = `<p class="mb-2 text-xs text-gray-500">Updates will appear on reload.</p><textarea class="w-full h-32 text-xs font-mono border p-2 bg-gray-50 rounded">${codeString}</textarea>`;
            }, 100);
        }

        function cancelImageUpdate() {
            if(tempImageLayer) map.removeLayer(tempImageLayer);
            if(tempControlBox) map.removeLayer(tempControlBox);
            if(savedImageLayer) savedImageLayer.addTo(map);
            document.getElementById('imageEditControls').style.display = 'none';
            tempImageLayer = null;
            tempControlBox = null;
        }

        // --- TAG SYSTEM & EDITING ---
        function renderTags(container, tags, id) {
            const input = container.querySelector('.tag-input');
            container.innerHTML = ''; 
            tags.forEach((tag, index) => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag';
                tagEl.innerHTML = `<span>${tag}</span><span class="tag-close" onclick="removeTag('${id}', ${index}, event)">&times;</span>`;
                container.appendChild(tagEl);
            });
            container.appendChild(input);
        }

        window.removeTag = function(id, index, e) {
            e.stopPropagation(); 
            drawnItems.eachLayer(layer => {
                if (layer.feature.properties.id === id) {
                    let currentProducts = layer.feature.properties.products || "";
                    let tags = currentProducts.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    tags.splice(index, 1); 
                    layer.feature.properties.products = tags.join(', ');
                    const container = document.getElementById(`tags-${id}`);
                    if(container) renderTags(container, tags, id);
                }
            });
            saveToLocal(); markUnsaved();
        };

        window.addTag = function(id, value) {
            const cleanVal = value.trim().replace(/,$/, ''); 
            if (!cleanVal) return;
            drawnItems.eachLayer(layer => {
                if (layer.feature.properties.id === id) {
                    let currentProducts = layer.feature.properties.products || "";
                    let tags = currentProducts.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    tags.push(cleanVal);
                    layer.feature.properties.products = tags.join(', ');
                    const container = document.getElementById(`tags-${id}`);
                    if(container) {
                        renderTags(container, tags, id);
                        const input = container.querySelector('.tag-input');
                        input.value = '';
                        input.focus();
                    }
                }
            });
            saveToLocal(); markUnsaved();
        };

        function setupTagInput(inputElement, rowId) {
            let currentFocus = -1;
            inputElement.addEventListener("input", function(e) {
                const val = this.value;
                closeAllLists();
                if (!val) return false;
                if (val.includes(',')) { addTag(rowId, val.replace(',', '')); return; }

                currentFocus = -1;
                const listDiv = document.createElement("DIV");
                listDiv.setAttribute("id", this.id + "autocomplete-list");
                listDiv.setAttribute("class", "autocomplete-list");
                this.parentNode.appendChild(listDiv); 
                this.parentNode.style.position = 'relative';

                let matchCount = 0;
                for (let i = 0; i < masterPlantList.length; i++) {
                    if (masterPlantList[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        if(matchCount > 8) break;
                        matchCount++;
                        const itemDiv = document.createElement("DIV");
                        itemDiv.className = "autocomplete-item";
                        itemDiv.innerHTML = "<strong>" + masterPlantList[i].substr(0, val.length) + "</strong>";
                        itemDiv.innerHTML += masterPlantList[i].substr(val.length);
                        itemDiv.innerHTML += "<input type='hidden' value='" + masterPlantList[i] + "'>";
                        itemDiv.addEventListener("click", function(e) { addTag(rowId, this.getElementsByTagName("input")[0].value); closeAllLists(); });
                        listDiv.appendChild(itemDiv);
                    }
                }
            });
            inputElement.addEventListener("keydown", function(e) {
                if (e.key === "Tab" || e.key === "Enter") { e.preventDefault(); if(this.value.trim() !== "") { addTag(rowId, this.value); closeAllLists(); } }
                if (e.key === "Backspace" && this.value === "") {
                    drawnItems.eachLayer(layer => {
                        if (layer.feature.properties.id === rowId) {
                            let currentProducts = layer.feature.properties.products || "";
                            let tags = currentProducts.split(',').map(s => s.trim()).filter(s => s.length > 0);
                            if(tags.length > 0) removeTag(rowId, tags.length - 1, e);
                        }
                    });
                }
            });
            document.addEventListener("click", function (e) { closeAllLists(e.target); });
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-list");
                for (var i = 0; i < x.length; i++) { if (elmnt != x[i] && elmnt != inputElement) x[i].parentNode.removeChild(x[i]); }
            }
        }

        // --- REST OF APP LOGIC ---
        function fetchMasterPlantList() {
            if(!MASTER_LIST_URL) return;
            Papa.parse(MASTER_LIST_URL, {
                download: true, header: false,
                complete: function(results) {
                    const fetchedPlants = results.data.map(row => row[0]).filter(p => p && p.length > 1);
                    if(fetchedPlants.length > 0) masterPlantList = fetchedPlants;
                }
            });
        }

        function markUnsaved() { document.getElementById('unsavedChangesMsg').classList.remove('hidden'); }
        function markSaved() { document.getElementById('unsavedChangesMsg').classList.add('hidden'); }
        function toggleSnap() {
            snapEnabled = !snapEnabled;
            const btn = document.getElementById('btnSnap'), txt = document.getElementById('snapText');
            if(snapEnabled) { btn.classList.add('snap-active'); txt.innerText = "Snap: ON"; showToast("Grid Snapping Enabled", "success"); }
            else { btn.classList.remove('snap-active'); txt.innerText = "Snap: OFF"; showToast("Grid Snapping Disabled", "info"); }
        }
        function snapValue(val) { return Math.round(val / GRID_STEP) * GRID_STEP; }
        function snapLayerToGrid(layer) {
            const b = layer.getBounds();
            layer.setBounds(L.latLngBounds([snapValue(b.getSouth()), snapValue(b.getWest())], [snapValue(b.getNorth()), snapValue(b.getEast())]));
        }
        function toggleAdvancedMenu() { document.getElementById('advancedMenu').classList.toggle('hidden'); }
        window.addEventListener('click', (e) => { 
            const m = document.getElementById('advancedMenu'), b = document.querySelector('button[onclick="toggleAdvancedMenu()"]');
            if (m && !m.classList.contains('hidden') && !m.contains(e.target) && !b.contains(e.target)) m.classList.add('hidden');
        });

        function enableEditLayer(layer) {
            if (currentlyEditing === layer) return;
            disableAllEdits();
            if (layer.editing) {
                layer.editing.enable();
                currentlyEditing = layer;
                const id = layer.feature.properties.id;
                const sidebarItem = document.getElementById(`sidebar-item-${id}`);
                if (sidebarItem) {
                    sidebarItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    sidebarItem.classList.add('active', 'border-l-4', 'border-blue-500', 'bg-blue-50');
                }
            }
        }
        function disableAllEdits() {
            if (currentlyEditing) {
                if (snapEnabled && currentlyEditing instanceof L.Rectangle) snapLayerToGrid(currentlyEditing);
                currentlyEditing.editing.disable();
                saveToLocal();
                currentlyEditing = null;
            }
            document.querySelectorAll('.row-item').forEach(el => el.classList.remove('active', 'border-l-4', 'border-blue-500', 'bg-blue-50'));
        }

        // History
        function recordHistory(data) {
            const snapshot = JSON.stringify(data);
            if (historyIndex < historyStack.length - 1) historyStack = historyStack.slice(0, historyIndex + 1);
            if (historyStack.length > 0 && historyStack[historyStack.length - 1] === snapshot) return;
            historyStack.push(snapshot);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            historyIndex = historyStack.length - 1;
            updateUndoRedoUI();
        }
        window.undo = function() {
            if (historyIndex > 0) {
                historyIndex--;
                const ps = JSON.parse(historyStack[historyIndex]);
                disableAllEdits(); drawnItems.clearLayers(); loadDataToMap(ps); saveToLocal(false, true); showToast("Undo", "info"); markUnsaved();
            }
            updateUndoRedoUI();
        };
        window.redo = function() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                const ns = JSON.parse(historyStack[historyIndex]);
                disableAllEdits(); drawnItems.clearLayers(); loadDataToMap(ns); saveToLocal(false, true); showToast("Redo", "info"); markUnsaved();
            }
            updateUndoRedoUI();
        };
        function updateUndoRedoUI() {
            const u = document.getElementById('btnUndo'), r = document.getElementById('btnRedo');
            u.disabled = historyIndex <= 0; r.disabled = historyIndex >= historyStack.length - 1;
            u.style.opacity = u.disabled ? "0.3" : "1"; r.style.opacity = r.disabled ? "0.3" : "1";
        }

        function handleCreate(e) {
            const layer = e.layer;
            const id = `row-${Date.now().toString().slice(-4)}`;
            const name = "New Row";
            const type = lastUsedType;
            layer.setStyle({ color: ROW_TYPES[type] });
            if (snapEnabled && layer instanceof L.Rectangle) snapLayerToGrid(layer);
            
            const latlngs = layer.getLatLngs();
            const coords = (Array.isArray(latlngs[0]) ? latlngs[0] : latlngs).map(pt => [parseFloat(pt.lat.toFixed(6)), parseFloat(pt.lng.toFixed(6))]);
            layer.feature = layer.feature || {};
            layer.feature.properties = { id, name, type, color: ROW_TYPES[type], products: "", coords };
            layer.on('click', (ev) => { L.DomEvent.stopPropagation(ev); enableEditLayer(layer); });
            drawnItems.addLayer(layer);
            updateUI(); saveToLocal(); showToast("Row created!", "success");
        }

        function confirmLoadCloud() {
            showModal("Refresh from Google Sheet?", "This replaces unsaved changes.", [{ text: "Cancel", class: "bg-gray-200 text-gray-800", action: closeModal }, { text: "Reload Data", class: "bg-blue-600 text-white", action: () => executeLoadCloud(false) }]);
        }
        function executeLoadCloud(isAuto = false) {
            if(!isAuto) closeModal();
            showToast(isAuto ? "Loading live data..." : "Connecting...", "info");
            Papa.parse(CSV_URL + (CSV_URL.includes('?') ? '&' : '?') + 't=' + Date.now(), {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) { processCloudData(results.data); if(isAuto) showToast("Live data loaded.", "success"); }
                    else if(!isAuto) showModal("Error", "Spreadsheet empty.", [{text:"OK", class:"bg-gray-800 text-white", action:closeModal}]);
                },
                error: function(err) {
                    console.error(err);
                    if(isAuto) {
                        const saved = localStorage.getItem('gardenMapData');
                        if (saved) { try { const p = JSON.parse(saved); drawnItems.clearLayers(); loadDataToMap(p); recordHistory(p); showToast("Offline: Loaded local backup.", "warning"); } catch(e){ updateUI(); } }
                    } else showModal("Connection Error", "Check internet.", [{text:"OK", class:"bg-gray-800 text-white", action:closeModal}]);
                }
            });
        }
        function processCloudData(data) {
            const newRows = [];
            data.forEach(row => {
                const id = getCol(row, ['Row ID', 'id', 'ID']);
                let coordsRaw = getCol(row, ['Coords', 'Coordinates', 'Coordinates (Do Not Edit)']);
                const name = getCol(row, ['Row Name', 'name', 'Name']) || "Unnamed Row";
                let type = getCol(row, ['Type', 'type']) || "Annuals";
                const products = getCol(row, ['Products', 'products']) || "";
                if(!coordsRaw || !id) return;
                if (!ROW_TYPES[type]) type = 'Annuals';
                try {
                    if (typeof coordsRaw === 'string' && coordsRaw.startsWith('"')) coordsRaw = coordsRaw.substring(1, coordsRaw.length - 1).replace(/""/g, '"');
                    newRows.push({ id, name, type, products, color: ROW_TYPES[type] || "#8B0000", coords: JSON.parse(coordsRaw) });
                } catch (e) { console.error("Row Parse Error", e); }
            });
            drawnItems.clearLayers();
            if(newRows.length > 0) loadDataToMap(newRows);
            saveToLocal(); markSaved(); updateUI();
        }
        function getCol(row, aliases) { for (const key of Object.keys(row)) { if (aliases.some(n => n.toLowerCase() === key.toLowerCase().trim())) return row[key]; } return null; }
        function loadDataToMap(data) {
            data.forEach(row => {
                let layer = (row.coords.length === 4) ? L.rectangle(L.latLngBounds(row.coords), { color: row.color, weight: 2 }) : L.polygon(row.coords, { color: row.color, weight: 2 });
                layer.feature = { properties: row };
                layer.on('click', (e) => { L.DomEvent.stopPropagation(e); enableEditLayer(layer); });
                drawnItems.addLayer(layer);
            });
            updateUI();
        }

        function updateUI() {
            if (!drawnItems) return;
            const list = document.getElementById('rowsList');
            const layers = drawnItems.getLayers();
            document.getElementById('rowCount').innerText = layers.length;
            list.innerHTML = '';
            rowsData = []; 

            if (layers.length === 0) { list.innerHTML = `<div class="text-gray-400 text-sm italic text-center mt-10">Map is empty.<br>Draw a row to start.</div>`; return; }

            let items = [];
            layers.forEach(layer => {
                const props = layer.feature.properties;
                const latlngs = layer.getLatLngs();
                props.coords = (Array.isArray(latlngs[0]) ? latlngs[0] : latlngs).map(pt => [parseFloat(pt.lat.toFixed(6)), parseFloat(pt.lng.toFixed(6))]);
                items.push({ layer, props });
            });

            items.sort((a, b) => (a.props.name || "").localeCompare(b.props.name || ""));

            items.forEach(item => {
                const layer = item.layer;
                const props = item.props;
                rowsData.push(props); 

                let optionsHtml = '';
                for (const [typeName] of Object.entries(ROW_TYPES)) {
                    optionsHtml += `<option value="${typeName}" ${props.type === typeName ? 'selected' : ''}>${typeName}</option>`;
                }

                const div = document.createElement('div');
                div.id = `sidebar-item-${props.id}`;
                div.className = "row-item bg-white p-3 rounded shadow-sm border border-gray-200 cursor-pointer mb-2";
                
                const tags = (props.products || "").split(',').map(s => s.trim()).filter(s => s.length > 0);

                div.innerHTML = `
                    <div class="flex justify-between items-start gap-2 mb-2">
                        <div class="flex-1">
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Row Name</label>
                            <input type="text" value="${props.name}" class="w-full font-bold text-gray-800 text-sm border-b border-gray-300 focus:border-blue-500 focus:outline-none bg-transparent" onchange="updateRowProperty('${props.id}', 'name', this.value)">
                        </div>
                        <button onclick="confirmDelete('${props.id}')" class="text-gray-300 hover:text-red-500 transition px-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-full">
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Row Type</label>
                            <div class="flex items-center gap-2">
                                <div id="color-swatch-${props.id}" class="w-4 h-4 rounded border border-gray-300 shadow-sm" style="background-color: ${props.color}"></div>
                                <select onchange="updateRowProperty('${props.id}', 'type', this.value)" class="flex-1 text-xs font-semibold bg-gray-100 rounded px-1 py-1 border-none outline-none cursor-pointer">${optionsHtml}</select>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Products</label>
                        <div class="tag-container" id="tags-${props.id}" onclick="document.getElementById('tag-input-${props.id}').focus()">
                            <input type="text" class="tag-input" id="tag-input-${props.id}" placeholder="Type product..." autocomplete="off">
                        </div>
                    </div>
                `;
                
                div.addEventListener('click', (e) => {
                    if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
                    if (e.target.closest('button') || e.target.closest('.tag-close') || e.target.closest('.tag')) return;
                    map.flyToBounds(layer.getBounds(), { padding: [50, 50] });
                    enableEditLayer(layer);
                });

                list.appendChild(div);
                
                const tagContainer = div.querySelector(`#tags-${props.id}`);
                renderTags(tagContainer, tags, props.id);
                const tagInput = div.querySelector(`#tag-input-${props.id}`);
                setupTagInput(tagInput, props.id);
            });
        }

        window.updateRowProperty = function(id, key, value) {
            drawnItems.eachLayer(layer => {
                if (layer.feature.properties.id === id) {
                    layer.feature.properties[key] = value;
                    if (key === 'type') {
                        const newColor = ROW_TYPES[value] || "#8B0000";
                        layer.feature.properties.color = newColor;
                        layer.setStyle({ color: newColor });
                        const swatch = document.getElementById(`color-swatch-${id}`);
                        if(swatch) swatch.style.backgroundColor = newColor;
                        lastUsedType = value; 
                    }
                }
            });
            saveToLocal(); markUnsaved();
        };

        window.confirmDelete = function(id) { showModal("Delete Row?", "Cannot be undone.", [{text:"Cancel", class:"bg-gray-200 text-gray-800", action: closeModal}, {text:"Delete", class:"bg-red-600 text-white", action: () => executeDelete(id)}]); };
        function executeDelete(id) { closeModal(); let found = false; drawnItems.eachLayer(layer => { if (layer.feature.properties.id === id) { drawnItems.removeLayer(layer); found = true; } }); if(found) { updateUI(); saveToLocal(); showToast("Row Deleted", "error"); markUnsaved(); } }

        // --- UPDATED SYNC LOGIC ---
        async function syncToGoogle() {
            saveToLocal(); // Ensure data is fresh
            if (rowsData.length === 0) { showToast("Draw some rows first!", "error"); return; }
            
            const btn = document.getElementById('syncBtn');
            const oldHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
            btn.disabled = true;
            showToast("Syncing to Google Sheet...", "info");

            try {
                // CHANGED: Use text/plain to avoid CORS Preflight failure issues with opaque requests
                // Google Apps Script usually handles text payload fine if parsed manually on server or if it auto-detects JSON in body.
                // NOTE: 'no-cors' mode is intentionally removed to see if actual errors can be caught, 
                // OR kept if you want to allow opaque response.
                // Standard approach for simple webhooks is usually NO-CORS + text/plain to allow "fire and forget".
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Keep no-cors for Google Apps Script Web App compatibility (opaque response)
                    headers: { 'Content-Type': 'text/plain' }, // Switch to text/plain to avoid preflight
                    body: JSON.stringify(rowsData)
                });
                
                showToast("Sync Complete!", "success");
                markSaved(); 
            } catch (error) {
                console.error("Sync Error:", error);
                showToast("Sync Failed. Check Internet.", "error");
            } finally {
                btn.innerHTML = oldHTML;
                btn.disabled = false;
            }
        }

        function saveToLocal(notify=false, skipHistory=false) {
            if(!drawnItems) return;
            const data = [];
            drawnItems.eachLayer(layer => {
                const props = layer.feature.properties;
                const latlngs = layer.getLatLngs();
                const coords = (Array.isArray(latlngs[0]) ? latlngs[0] : latlngs).map(pt => [parseFloat(pt.lat.toFixed(6)), parseFloat(pt.lng.toFixed(6))]);
                data.push({ ...props, coords }); 
            });
            if (!skipHistory) recordHistory(data);
            localStorage.setItem('gardenMapData', JSON.stringify(data));
            rowsData = data;
            if(notify) showToast("Saved to browser!", "success");
        }

        function showToast(msg, type="info") {
            const t = document.getElementById('toast'), i = document.getElementById('toastIcon'), txt = document.getElementById('toastMessage');
            txt.innerText = msg; t.className = ""; t.classList.add(type);
            if(type === 'success') i.className = "fa-solid fa-check-circle"; else if(type === 'error' || type === 'warning') i.className = "fa-solid fa-triangle-exclamation"; else i.className = "fa-solid fa-info-circle";
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
        }
        function showModal(title, msg, actions) {
            document.getElementById('modalTitle').innerText = title; document.getElementById('modalMessage').innerText = msg;
            const ac = document.getElementById('modalActions'); ac.innerHTML = '';
            actions.forEach(a => { const b = document.createElement('button'); b.innerText = a.text; b.className = `px-4 py-2 rounded text-sm font-bold ${a.class}`; b.onclick = a.action; ac.appendChild(b); });
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
        
        function downloadCSV() {
            saveToLocal(); if (rowsData.length === 0) return;
            let csv = "data:text/csv;charset=utf-8,Row ID,Row Name,Type,Products,Coords\n";
            rowsData.forEach(r => { const sp = (r.products || "").replace(/"/g, '""'); csv += `${r.id},${r.name},${r.type},"${sp}","${JSON.stringify(r.coords).replace(/"/g, '""')}"\n`; });
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "gertens-map-locations.csv"; link.click();
        }
        function copyJSON() {
            saveToLocal();
            const json = JSON.stringify(rowsData, null, 4);
            const box = document.getElementById("hiddenCopy");
            box.value = json;
            box.select();
            document.execCommand("copy");
            showToast("JSON Copied", "success");
        }
    </script>
</body>
</html>
